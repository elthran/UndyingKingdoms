{% extends "gameplay/layout.html" %}

{% title block %}Town Hall: {{ super() }}{% endblock %}

{% block content2 %}

{% set user = current_user %}
{% set county = current_user.county %}
{% set kingdom = county.kingdom %}
<h1>Discussion</h1>
<div style="border:solid 1px;width:auto;min-height:300px;margin-left:250px;margin-right:250px;">
<ul id="chatlist">
</ul>
</div>
<br>
<form method="POST" accept-charset="UTF-8" role="form">
	{{ form.csrf_token }}
	<input style="width: 300px;" autofocus="" class="form-control " id="content" name="content" placeholder="Public to your kingdom" required type="text" value="">
  <br><br>
  <button id="send" type="submit">Say</button>
</form>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script>
function formatDate(date) {
    var hours = ("0" + date.getHours()).slice(-2);
    var minutes = ("0" + date.getMinutes()).slice(-2);
    var seconds = ("0" + date.getSeconds()).slice(-2);

    return hours + ":" + minutes + ":" + seconds;
}

function build_element(time, leader, content) {
    // <li> 13:27:26  Haldon: Test message</li>
    var date = new Date(time + "Z");
    return $("<li></li>").text(
        "(" + formatDate(date) + ") " + leader + ": " + content
    );
}

function sendMessage() {
    $.ajaxSetup({
        headers: {"X-CSRF-TOKEN": $("#csrf_token").val()}
    });

    $.post("/gameplay/chatroom/", {
        content: $("#content").val(),
        updateOnly: false
    }, function (resp, status) {
        if (status === "success") {
            $("#content").val("");
            $("#chatlist").append(
                build_element(resp.data[0], resp.data[1], resp.data[2])
            );
        }
    });
}

$("form").submit(function (e) {
    e.preventDefault();
    sendMessage();
});

function updateChat() {
    $.ajaxSetup({
        headers: {"X-CSRF-TOKEN": $("#csrf_token").val()}
    });

    $.post("/gameplay/chatroom/", {
        message: "",
        updateOnly: true
    }, function (resp, status) {
        if (status === "success") {
            $("#csrf_token").val(resp.csrf);
            $("#chatlist").empty();
            $.each(resp.data, function (ignore, value) {
                $("#chatlist").append(
                    build_element(value[0], value[1], value[2])
                );
            });
        }
    });
}

var clock = {
    handle: null,
    run: function () {
        updateChat();  // run immediately on focus, then every x seconds.
        return setInterval(updateChat, 3000);
    }
};

// Active update function when the window gains focus.
$(window).on("focus", function () {
    clock.handle = clock.run();
});

// Stop update function when the window loses focus.
$(window).on("blur", function () {
    clearInterval(clock.handle);
});

// Pull chat date once page loads
$(document).ready(updateChat());
</script>
{% endblock %}
