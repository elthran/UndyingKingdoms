{% extends "gameplay/layout.html" %}

{% block title %}Military: {{ super() }}{% endblock %}

{% block style %}
{{ super() }}
<style type="text/css">
#content {
    padding-top: 1em;
}

input {
    padding: 0.5em 0 0;
}

#invisibleDataFields {
    display: none;
}
</style>
{% endblock %}

{% block content2 %}
{% set user = current_user %}
{% set county = current_user.county %}
{% set kingdom = county.kingdom %}
<!--min(each cost)-->
{% macro max_trainable_by_cost(army) %}
{{ ([county.gold // army.gold, county.wood // army.wood, county.iron // army.iron] | sort)[0] }}
{% endmacro %}
<div id="content">
  <h2>Current Attack Power Available: {{ county.get_offensive_strength(county=county) }}</h2>
  <h2>Current Defensive Power: {{ county.get_defensive_strength() }}</h2>
  <h2>{{ county.get_available_workers() }} workers available for training</h2>
  <form method="POST" accept-charset="UTF-8" role="form">
    {{ form.csrf_token }}
    <table class="production_table">
      <tr>
        <th>Name</th>
        <th>Available</th>
        <th>In Foreign Lands</th>
        <th>In Training</th>
        <th style="width:175px;">Train</th>
        <th style="min-width:125px;">Cost</th>
        <th>Trainable Per Day</th>
        <th>
          <div class="tooltip">Attack<span class="tooltipText">{{ meta_data["attack"] }}</span></div>
        </th>
        <th>
          <div class="tooltip">Defence<span class="tooltipText">{{ meta_data["defence"] }}</span></div>
        </th>
        <th>
          <div class="tooltip">Health<span class="tooltipText">{{ meta_data["health"] }}</span></div>
        </th>
        <th>
          <div class="tooltip">Upkeep<span class="tooltipText">{{ meta_data["upkeep"] }}</span></div>
        </th>
        <th>Description</th>
      </tr>
      {% for army in county.armies.values() %}
        <!-- {{ [county.gold // army.gold, county.wood // army.wood, county.iron // army.iron] }} -->
        <!--(list | sort)[0] replicates min()-->
        {% set slider_size = max_trainable_by_cost(army) | int %}
      <tr>
        <td>{{ army.class_name.title() }}</td>
        <td>{{ army.available }}</td>
        <td>{{ army.traveling }}</td>
        <td>{{ army.currently_training }}</td>
        <td>
          {% if army.base_name == 'monster' %}
          {% if county.buildings['lair'].total - county.armies['monster'].total - county.armies['monster'].currently_training <= 0 %}
            <input class="slider" type="range" value="0" min="0" max="{{ county.buildings['lair'].total - county.armies['monster'].total }}" step="1" hidden/>
            <span class="display" hidden>0</span>
            <span style="color:red;">Requires {{ county.buildings['lair'].class_name_plural.title() }}</span>
          {% else %}
            <input class="slider" type="range" value="0" min="0" max="{{ county.buildings['lair'].total - county.armies['monster'].total - county.armies['monster'].currently_training }}"
                   step="1"/>
            <span class="display">0</span>
          {% endif %}
          {% else %}
            <input class="slider" type="range" value="0" min="0" max="{{ slider_size }}" step="1"/>
            <span class="display">0</span>
          {% endif %}
          <input class="value" name="{{ army.base_name }}" value="0" hidden/>
        </td>
        <td>
          {% if army.gold %}
            <span class="buildingGoldCost">{{ army.gold }}</span>
            <img class="resource_icons" src="/static/images/gold_icon.jpg">
          {% endif %}
          {% if army.wood %}
            <span class="buildingWoodCost">{{ army.wood }}</span>
            <img class="resource_icons" src="/static/images/wood_icon.jpg">
          {% endif %}
          {% if army.iron %}
            <span class="buildingIronCost">{{ army.iron }}</span>
            <img class="resource_icons" src="/static/images/iron_icon.jpg">
          {% endif %}
          {% if army.gold == 0 and army.wood == 0 and army.iron == 0 %}Free{% endif %}
        </td>
        <td>{{ army.trainable_per_day }}</td>
        <td>{{ army.attack }}</td>
        <td>{{ army.defence }}</td>
        <td>{{ army.health }}</td>
        <td>{{ army.upkeep }}</td>
        <td>{{ army.description }}</td>
      </tr>
      {% endfor %}
      <tr style="font-weight:bold;">
        <td>Total</td>
        <td>{{ county.get_available_army_size() }}</td>
        <td>{{ county.get_unavailable_army_size() }}</td>
        <td>-</td>
        <td>-</td>
        <td>{{ county.get_training_army_size() }}</td>
        <td>-</td>
        <td>-</td>
        <td>-</td>
        <td>-</td>
        <td>
          <div class="tooltip">{{ county.get_upkeep_costs() }}<span
              class="tooltipText">{{ meta_data["upkeep_daily"] }}</span>
          </div>
        </td>
        <td>-</td>
      </tr>
    </table>
    <br>
    Gold Cost: <span id="goldCost">0</span>
    <img class="resource_icons" src="/static/images/gold_icon.jpg"> / {{ county.gold }} <img class="resource_icons" src="/static/images/gold_icon.jpg"><br>
    Wood Cost: <span id="woodCost">0</span>
    <img class="resource_icons" src="/static/images/wood_icon.jpg"> / {{ county.wood }} <img class="resource_icons" src="/static/images/wood_icon.jpg"><br>
    Iron Cost: <span id="ironCost">0</span>
    <img class="resource_icons" src="/static/images/iron_icon.jpg"> / {{ county.iron }} <img class="resource_icons"  src="/static/images/iron_icon.jpg"><br>
    Happiness Cost: <span id="happinessCost">0</span>
    <img class="resource_icons" src="/static/images/heart_icon.jpg">
    <br><br>
    <button id="submitButton" type="submit">Build</button>
    <br>
  </form>
  <br><br>
  <h2>Expeditions:</h2>
  {% for expedition in county.get_expeditions() %}
  <br>Your surviving {{ expedition.peasant + expedition.soldier + expedition.elite + expedition.monster }} troops will
  return in {{ expedition.duration }} days with {{ expedition.land_acquired }} acres of newly captured land.
  {% else %}
  You have no troops travelling in foreign lands.
  {% endfor %}
</div>
<div id="invisibleDataFields">
  <span id="population">{{ county.population }}</span>
  <span id="totalGold">{{ county.gold }}</span>
  <span id="totalWood">{{ county.wood }}</span>
  <span id="totalIron">{{ county.iron }}</span>
</div>
{% endblock %}

{% block script %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
{{ super() }}
<script type="text/javascript">
var sliders = $(".slider");
var displays = $(".display");
var values = $(".value");

var buildingGoldCosts = $(".buildingGoldCost");
var buildingWoodCosts = $(".buildingWoodCost");
var buildingIronCosts = $(".buildingWoodCost");

var submitButton = $("#submitButton");
var goldCost = $("#goldCost");
var woodCost = $("#woodCost");
var ironCost = $("#ironCost");
var happinessCost = $("#happinessCost");


var totalGold = parseInt($("#totalGold").text());
var totalWood = parseInt($("#totalWood").text());
var totalIron = parseInt($("#totalIron").text());
var population = parseInt($("#population").text());

function updateGold() {
    var sum = 0;
    sliders.each(function (index, element) {
        sum += element.value * buildingGoldCosts[index].innerHTML;
    });
    goldCost.html(sum);
}

function updateWood() {
    var sum = 0;
    sliders.each(function (index, element) {
        sum += element.value * buildingWoodCosts[index].innerHTML;
    });
    woodCost.html(sum);
}

function updateIron() {
    var sum = 0;
    sliders.each(function (index, element) {
        sum += element.value * buildingIronCosts[index].innerHTML;
    });
    ironCost.html(sum);
}

function updateHappiness() {
    var sum = 0;
    sliders.each(function (ignore, element) {
        sum += parseInt(element.value);
    });
    happinessCost.html(Math.ceil(sum / population * 100));
}

function updateCosts() {
    updateGold();
    updateWood();
    updateIron();
    updateHappiness();

    var gold = parseInt(goldCost.text());
    var wood = parseInt(woodCost.text());
    var iron = parseInt(ironCost.text());

    if (gold > totalGold) {
        goldCost.css("color", "red");
    } else {
        goldCost.css("color", "green");
    }

    if (wood > totalWood) {
        woodCost.css("color", "red");
    } else {
        woodCost.css("color", "green");
    }
    if (iron > totalIron) {
        ironCost.css("color", "red");
    } else {
        ironCost.css("color", "green");
    }
    if (gold <= totalGold && wood <= totalWood && iron <= totalIron) {
        submitButton.prop("disabled", false);
    } else {
        submitButton.prop("disabled", true);
    }
}


sliders.each(function (index, element) {
    $(element).on("input", function () {
        displays[index].innerHTML = $(element).val();
        values[index].value = $(element).val();
        updateCosts();
    });
});
</script>
{% endblock %}
