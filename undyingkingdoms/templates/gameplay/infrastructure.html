{% extends "gameplay/layout.html" %}

{% block title %}Infrastructure: {{ super() }}{% endblock %}

{% block style %}
{{ super() }}
<style type="text/css">
#content {
    padding-top: 1em;
}

input {
    padding: 0.5em 0 0;
}

#invisibleDataFields {
    display: none;
}

#costCol {
    min-width: 8.5em;
}

.slide-container {
    display: flex;
    justify-content: space-around;
    width: 10em;
}

/* The slider itself */
.slider {
  -webkit-appearance: none;  /* Override default CSS styles */
  appearance: none;
  width: 100%; /* Full-width */
  height: 0.1em; /* Specified height */
  background: #d3d3d3; /* Grey background */
  outline: none; /* Remove outline */
  -webkit-transition: .2s; /* 0.2 seconds transition on hover */
  transition: opacity .2s;
  padding: 0.1em 0 0.1em;
  margin: 1em 0 1em;
  width: 10em;
}

/* The slider handle (use -webkit- (Chrome, Opera, Safari, Edge) and -moz- (Firefox) to override default look) */
.slider::-webkit-slider-thumb {
  -webkit-appearance: none; /* Override default look */
  appearance: none;
  width: 0.4em; /* Set a specific slider handle width */
  height: 1.5em; /* Slider handle height */
  background: #4CAF50; /* Green background */
  cursor: pointer; /* Cursor on hover */
}

.slider::-moz-range-thumb {
  width: 0.4em; /* Set a specific slider handle width */
  height: 1.5em; /* Slider handle height */
  background: #4CAF50; /* Green background */
  cursor: pointer; /* Cursor on hover */
}

.slider-disabled::-moz-range-thumb  {
    background: grey;
}

.slider-disabled::-webkit-slider-thumb {
    background: grey;
}

table {
    margin-top: 1em;
}

tr:nth-child(even) {background-color: #f2f2f2;}

th, td {
    vertical-align: bottom;
    border: 1px solid #ddd;
    padding: 0 0.3em 0.3em;
}

th {
    font-weight: bold;
    vertical-align: middle;
}

.total-row {
    font-weight: bold;
    height: 2.6em;
}

.tooltip .tooltipText {
    /* Position the tooltip */
    position: absolute;
    z-index: 1;
    top: 120%;
    left: 50%;
    margin-left: -195px; /* Use half of the width (120/2 = 60), to center the tooltip */
}
</style>
{% endblock %}

{% block content2 %}
{% set user = current_user %}
{% set county = current_user.county %}
{% set kingdom = county.kingdom %}

<div id="content">
  <h2>Available Land: {{ county.get_available_land() }} / {{ county.land }}</h2><br>
  <h2>Unemployed Citizens : {{ county.get_available_workers() }} / {{ county.population }}</h2><br>
  <p>You may assign a task to your idle population. </p>

  <form action="{{ url_for('allocate_workers') }}" method="POST" accept-charset="UTF-8">
    {{ excess_worker_form.csrf_token }}
    {{ excess_worker_form.goal }}
    <button type="submit" id="choiceSubmit">Update</button>
  </form>

  <span id="excessProductionDescription"></span>


  <h2>Current Resources:
    {{ county.gold }} <img class="resource_icons" src="/static/images/gold_icon.jpg">
    {{ county.wood }} <img class="resource_icons" src="/static/images/wood_icon.jpg">
    {{ county.iron }} <img class="resource_icons" src="/static/images/iron_icon.jpg">
  </h2>
  <br>
  <form action="{{ url_for('build_buildings') }}" method="POST" accept-charset="UTF-8">
    {{ build_form.csrf_token }}
    <table>
      <tr>
        <th style="width:150px;">Name</th>
        <th>Owned</th>
        <th style="width:175px;">To Be Built</th>
        <th>Under Construction</th>
        <th style="width:150px;">Cost</th>
        <th style="width:150px;">Workers Employed</th>
        <th>Description</th>
      </tr>
      {% for building in county.buildings.values() %}
        {% set slider_size = max_buildable_by_cost(county, building) %}
      <tr>
        <td>{{ building.class_name.title() }}</td>
        <td>{{ building.total }}</td>
        <td>
          <div class="slide-container">
            <input class="slider" type="range" value="0" min="0" max="{{ slider_size }}" step="1"/>
          </div>
          <span class="display">0</span>
          <input class="value" name="{{ building.base_name }}" value="0" hidden/>
        </td>
        <td>{{ building.pending }}</td>
        <td>
          <span class="buildingGoldCost">{{ building.gold_cost or 0 }}</span><img class="resource_icons" src="/static/images/gold_icon.jpg">
          <span class="buildingWoodCost">{{ building.wood_cost or 0 }}</span><img class="resource_icons" src="/static/images/wood_icon.jpg">
        </td>
        <td>{{ building.workers_employed * building.total }} ({{ building.workers_employed }} each)</td>
        <td>{{ building.description }}</td>
      </tr>
      {% endfor %}
      <tr style="font-weight:bold;">
        <td style="width:150px;">Total</td>
        <td>{{ county.buildings.values()|sum(attribute='total') }}</td>
        <td>-</td>
        <td>{{ county.buildings.values()|sum(attribute='pending') }}</td>
        <td style="width:150px;">-</td>
        <td style="width:150px;">{{ county.get_employed_workers() }}</td>
        <td>-</td>
      </tr>
    </table>
    <br>
    Gold Cost: <span id="goldCost">0</span>
    <img class="resource_icons" src="/static/images/gold_icon.jpg"> / {{ county.gold }} <img src="/static/images/gold_icon.jpg"><br>
    Wood Cost: <span id="woodCost">0</span>
    <img class="resource_icons" src="/static/images/wood_icon.jpg"> / {{ county.wood }} <img src="/static/images/wood_icon.jpg"><br>
    Land Required: <span id="landCost">0</span> / {{ county.get_available_land() }}
    <br><br>
    Each day, up to {% if county.background == 'Engineer' %}5{% else %}3{% endif %} buildings in your queue will be built.
    <br>
    <button id="buildSubmit" type="submit">Build</button>
    <br>
  </form>
</div>
<div id="invisibleDataFields">
  <span id="totalGold">{{ county.gold }}</span>
  <span id="totalWood">{{ county.wood }}</span>
  <span id="totalLand">{{ county.get_available_land() }}</span>
</div>
{% endblock %}

{% block script %}
{{ super() }}
{% set county = current_user.county %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script type="text/javascript">
var sliders = $(".slider");
var displays = $(".display");
var values = $(".value");

var buildingGoldCosts = $(".buildingGoldCost");
var buildingWoodCosts = $(".buildingWoodCost");

var goldCost = $("#goldCost");
var woodCost = $("#woodCost");
var landCost = $("#landCost");

var totalGold = parseInt($("#totalGold").text());
var totalWood = parseInt($("#totalWood").text());
var totalLand = parseInt($("#totalLand").text());

function updateGold() {
    var sum = 0;
    sliders.each(function (index, element) {
        sum += element.value * buildingGoldCosts[index].innerHTML;
    });
    goldCost.html(sum);
}

function updateWood() {
    var sum = 0;
    sliders.each(function (index, element) {
        sum += element.value * buildingWoodCosts[index].innerHTML;
    });
    woodCost.html(sum);
}

function updateLand() {
    var sum = 0;
    sliders.each(function (index, element) {
        // someday this 1 will be a land cost.
        sum += element.value * 1;
    });
    landCost.html(sum);
}

function calcSliderWidth(size) {
    return Math.min(size + 0.8, 10) + "em";
}

function resizeRemaining(gold, wood, land) {
    // console.log(sliders);
    sliders.each(function (index, element) {
        var goldPrice = buildingGoldCosts[index].innerHTML;
        var woodPrice = buildingWoodCosts[index].innerHTML;
        var landPrice = 1;  // someday will be land cost
        var remaining = Math.max(Math.floor(Math.min(
            (totalGold - gold) / goldPrice,
            (totalWood - wood) / woodPrice,
            (totalLand - land) / landPrice
        )), 0);

        var size = parseInt(element.value) + remaining;
        // need to include current element.value + current_max - remaining?
        $(element).prop("max", size);
        $(element).css("width", calcSliderWidth(size));
        if (size === 0) {
            $(element).addClass("slider-disabled");
        } else {
            $(element).removeClass("slider-disabled");
        }
    });
}

function updateCosts() {
    updateGold();
    updateWood();
    updateLand();

    var gold = parseInt(goldCost.text());
    var wood = parseInt(woodCost.text());
    var land = parseInt(landCost.text());
    resizeRemaining(gold, wood, land);
}

sliders.each(function (index, element) {
    var size = parseInt($(element).prop("max"));
    if (size === 0) {
        $(element).addClass("slider-disabled");
    }
    $(element).css("width", calcSliderWidth(size));
    $(element).on("input", function () {
        displays[index].innerHTML = $(element).val();
        values[index].value = $(element).val();
        updateCosts();
    });
});

var goalChoice = $("#goal");
var goalDescription = $("#excessProductionDescription");

goalChoice.oninput = function() {
    updateGoals();
};

function updateGoals() {
    if (goalChoice.value == 0) {
        var goalAmount = {{ county.get_excess_production_value(0) }};
        goalDescription.innerHTML = "Your idle citizens will be forced to work, earning your county an additional " + goalAmount + " gold per day.";
    } else if (goalChoice.value == 1) {
        var goalAmount = {{ county.get_excess_production_value(1) }};
        var landReclaimed = {{ county.produce_land }};
        goalDescription.innerHTML = "Your idle citizens will be forced to reclaim overgrown land surrounding your county. You are currently " + landReclaimed + " / 2000 square meters towards reclaiming an acre. You will advance " + goalAmount + " square meters each day.";
    } else if (goalChoice.value == 2) {
        var goalAmount = {{ county.get_excess_production_value(2) }};
        goalDescription.innerHTML = "Your idle citizens will be forced to forage for food, gaining enough for " + goalAmount + " people each day.";
    } else if (goalChoice.value == 3) {
        var goalAmount = {{ county.get_excess_production_value(3) }};
        goalDescription.innerHTML = "Your idle citizens will be allowed to relax, gaining " + goalAmount + " happiness per day.";
    }
}

$(document).ready(function() {
  updateGoals();
});
</script>

{% endblock %}

