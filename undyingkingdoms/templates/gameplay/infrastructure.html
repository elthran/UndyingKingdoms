{% extends "gameplay/layout.html" %}

{% block title %}Infrastructure: {{ super() }}{% endblock %}

{% block style %}
{{ super() }}
<style type="text/css">
#content {
    padding-top: 1em;
}

input {
    padding: 0.5em 0 0;
}


</style>
{% endblock %}

{% block content2 %}
{% set user = current_user %}
{% set county = current_user.county %}
{% set kingdom = county.kingdom %}

<div id="content">
    <h2>Available Land: {{ county.get_available_land() }} / {{ county.land }}</h2><br>
    <h2>Unemployed Citizens : {{ county.get_available_workers() }} / {{ county.population }}</h2><br>
    <p>You may assign a task to your idle population. </p>

    <form action="{{ url_for('infrastructure') + '?id=excess' }}" method="POST" accept-charset="UTF-8">
        {{ excess_worker_form.csrf_token }}
        {{ excess_worker_form.goal }}
        <button type="submit" id="choiceSubmit">Update</button>
    </form>

    <span id="excessProductionDescription"></span>


    <h2>Current Resources:
        {{ county.gold }} <img class="resource_icons" src="/static/images/gold_icon.jpg">
        {{ county.wood }} <img class="resource_icons" src="/static/images/wood_icon.jpg">
        {{ county.iron }} <img class="resource_icons" src="/static/images/iron_icon.jpg">
    </h2>
    <br>
    <form action="{{ url_for('infrastructure') + '?id=build' }}" method="POST" accept-charset="UTF-8">
        {{ build_form.csrf_token }}
        <table class="production_table">
            <tr>
                <th style="width:150px;">Name</th>
                <th>Owned</th>
                <th style="width:175px;">To Be Built</th>
                <th>Under Construction</th>
                <th style="width:150px;">Cost</th>
                <th style="width:150px;">Workers Employed</th>
                <th>Description</th>
            </tr>
            {% for building in county.buildings.values() %}
            <tr>
                <td>{{ building.class_name.title() }}</td>
                <td>{{ building.total }}</td>
                <td>
                    <input id="{{ building.base_name }}_slider" type="range" value="0" min="0" max="20" step="1"/>
                    <span id="{{ building.base_name }}_display">0</span>
                    <input id="{{ building.base_name }}_value" name="{{ building.base_name }}" value="0" hidden/>
                </td>
                <td>{{ building.pending }}</td>
                <td>
                    {% if building.gold_cost %}{{ building.gold_cost }}<img class="resource_icons"
                                                                  src="/static/images/gold_icon.jpg">{% endif %}
                    {% if building.wood_cost %}{{ building.wood_cost }}<img class="resource_icons"
                                                                  src="/static/images/wood_icon.jpg">{% endif %}
                </td>
                <td>{{ building.workers_employed * building.total }} ({{ building.workers_employed }} each)</td>
                <td>{{ building.description }}</td>
            </tr>
            {% endfor %}
            <tr style="font-weight:bold;">
                <td style="width:150px;">Total</td>
                <td>{{ county.buildings.values()|sum(attribute='total') }}</td>
                <td>-</td>
                <td>{{ county.buildings.values()|sum(attribute='pending') }}</td>
                <td style="width:150px;">-</td>
                <td style="width:150px;">{{ county.get_employed_workers() }}</td>
                <td>-</td>
            </tr>
        </table>
        <br>
        Gold Cost: <span id="goldCost">0</span>
        <img class="resource_icons" src="/static/images/gold_icon.jpg"> / {{ county.gold }} <img class="resource_icons"
                                                                                                 src="/static/images/gold_icon.jpg"><br>
        Wood Cost: <span id="woodCost">0</span>
        <img class="resource_icons" src="/static/images/wood_icon.jpg"> / {{ county.wood }} <img class="resource_icons"
                                                                                                 src="/static/images/wood_icon.jpg"><br>
        Land Required: <span id="landCost">0</span> / {{ county.get_available_land() }}
        <br><br>
        Each day, up to {% if county.background == 'Engineer' %}5{% else %}3{% endif %} buildings in your queue will be built.
        <br>
        <button id="buildSubmit" type="submit">Build</button>
        <br>
    </form>
</div>
{% endblock %}

{% block script %}
{{ super() }}
{% set county = current_user.county %}
<script type="text/javascript">
var submitButton = document.getElementById("buildSubmit");
var goldCost = document.getElementById("goldCost");
var woodCost = document.getElementById("woodCost");
var landCost = document.getElementById("landCost");
window.onload = function() {
  updateGoals();
};

{% for building in county.buildings.values() %}
var {{ building.base_name }}_slider = document.getElementById("{{ building.base_name }}_slider");
var {{ building.base_name }}_display = document.getElementById("{{ building.base_name }}_display");
var {{ building.base_name }}_value = document.getElementById("{{ building.base_name }}_value");
{% endfor %}

function updateGold() {
    goldCost.innerHTML = 0{% for building in county.buildings.values() %} +
    {{ building.base_name }}_slider.value * {{ building.gold_cost }}{% endfor %};
}

function updateWood() {
    woodCost.innerHTML = 0{% for building in county.buildings.values() %} +
    {{ building.base_name }}_slider.value * {{ building.wood_cost }}{% endfor %};
}

function updateLand() {
    landCost.innerHTML = 0{% for building in county.buildings.values() %} +
    parseInt({{ building.base_name }}_slider.value){% endfor %};
}

function updateCosts() {
    updateGold();
    updateWood();
    updateLand();
    var gold = parseInt(goldCost.innerHTML);
    if (gold > {{ county.gold }}) {
        goldCost.style.color = "red";
    } else {
        goldCost.style.color = "green";
    }
    var wood = parseInt(woodCost.innerHTML);
    if (wood > {{ county.wood }}) {
        woodCost.style.color = "red";
    } else {
        woodCost.style.color = "green";
    }
    var land = parseInt(landCost.innerHTML);
    if (land > {{ county.get_available_land() }}) {
        landCost.style.color = "red";
    } else {
        landCost.style.color = "green";
    }
    if (gold <= {{ county.gold }} && wood <= {{ county.wood }} && land <= {{ county.get_available_land() }}) {
        submitButton.disabled = false;
    } else {
        submitButton.disabled = true;
    }
}

{% for building in county.buildings.values() %}
{{ building.base_name }}_slider.oninput = function () {
    {{ building.base_name }}_display.innerHTML = this.value;
    {{ building.base_name }}_value.value = this.value;
    updateCosts();
};
{% endfor %}

var goalChoice = document.getElementById('goal');
var goalDescription = document.getElementById('excessProductionDescription');
goalChoice.oninput = function() {
    updateGoals();
};

function updateGoals() {
    if (goalChoice.value == 0) {
        var goalAmount = {{ county.temporary_prod_value(0) }};
        goalDescription.innerHTML = 'Your idle citizens will be forced to work, earning your county additional ' + goalAmount + ' gold per day.';
    } else if (goalChoice.value == 1) {
        var goalAmount = {{ county.temporary_prod_value(1) }};
        var landReclaimed = {{ county.produce_land }};
        goalDescription.innerHTML = 'Your idle citizens will be forced to reclaim overgrown land surrounding your county. You are currently ' + landReclaimed + ' / 2000 square meters towards reclaiming an acre. You will advance ' + goalAmount + ' square meters each day.';
    } else if (goalChoice.value == 2) {
        var goalAmount = {{ county.temporary_prod_value(2) }};
        goalDescription.innerHTML = 'Your idle citizens will be forced to forage for food, gaining enough for ' + goalAmount + ' people each day.';
    } else if (goalChoice.value == 3) {
        var goalAmount = {{ county.temporary_prod_value(3) }};
        goalDescription.innerHTML = 'Your idle citizens will be allowed to relax, gaining ' + goalAmount + ' happiness per day.';
    }
}

</script>

{% endblock %}

