{% extends "mobile/gameplay/layout.html" %}
{% set user = current_user %}
{% set county = current_user.county %}
{% set kingdom = county.kingdom %}

{% block title %}Infrastructure: {{ super() }}{% endblock %}

{% block style %}
{{ super() }}
<style type="text/css">
#content {
	margin: 1.2em 2em;
}
h1 {
	padding-bottom: 0.4em;
	text-align: center;
}

h2 {
	padding-bottom: 0.3em;
}

button {
	width: 90%;
	border-radius: 4px;
	padding: 0.3em;
	margin-top: 0.3em;
}

#table {
	display: flex;
}

.col > div {
	min-height: 2em;
}

th {
	font-weight: bold;
	font-size: 1.3em;
}

</style>
{% endblock %}

{% block content1 %}
<div id="content">
	<h2>Total Land: {{ county.land }}</h2>
	<h2>Available Land: {{ county.get_available_land() }}</h2>
	<h2>Daily Production:
		{{ county.get_production()|int }} <img class="resource_icons" src="/static/images/prod_icon.jpg">
		(<div class="tooltip">{{ county.get_available_workers() }} available workers
			<span class="tooltipText">{{ meta_data["available_workers"] }}</span>
		</div>)
	</h2>
	<h2>Current Resources:
		{{ county.gold }} <img class="resource_icons" src="/static/images/gold_icon.jpg">
		{{ county.wood }} <img class="resource_icons" src="/static/images/wood_icon.jpg">
		{{ county.iron }} <img class="resource_icons" src="/static/images/iron_icon.jpg">
	</h2>
	<br>
	<form method="POST" accept-charset="UTF-8" role="form">
		{{ form.csrf_token }}
		<table class="production_table">
			<tbody>
				{% for building in county.buildings.values() %}
				<tr>
					<th colspan="2">{{ building.class_name.title() }}</th>
				</tr>
				<tr>
					<td>Owned</td>
					<td>{{ building.total }}</td>
				</tr>
				<tr>
					<td>Under Construction</td>
					<td>{{ building.pending }}</td>
				</tr>
				<tr>
					<td>To Be Built</td>
					<td>
						<input id="{{ building.base_name }}_slider" type="range" value="0" min="0" max="20" step="1"/>
						<span id="{{ building.base_name }}_display">0</span>
						<input id="{{ building.base_name }}_value" name="{{ building.base_name }}" value="0" hidden/>
						<button id="submitButton" type="submit">Build</button>
					</td>
				</tr>
				<tr>
					<td>Cost</td>
					<td>
						{{ building.production_cost }}<img class="resource_icons" src="/static/images/prod_icon.jpg">
						{% if building.gold %}{{ building.gold }}<img class="resource_icons" src="/static/images/gold_icon.jpg">{%
						endif %}
						{% if building.wood %}{{ building.wood }}<img class="resource_icons" src="/static/images/wood_icon.jpg">{%
						endif %}
					</td>
				</tr>
				<tr>
					<td>Workers Employed</td>
					<td>{{ building.labour_maintenance * building.total }} ({{ building.labour_maintenance }} each)</td>
				</tr>
				<tr>
					<td>Description</td>
					<td>{{ building.description }}</td>
				</tr>
				{% endfor %}
				<tr style="font-weight:bold;">
					<th colspan="2" style="width:150px;">Total</th>
				</tr>
				<tr>
					<td>Owned</td>
					<td>{{ county.buildings.values()|sum(attribute='total') }}</td>
				</tr>
				<tr>
					<td>Under Construction</td>
					<td>{{ county.buildings.values()|sum(attribute='pending') }}</td>
				</tr>
				<tr>
					<td>To Be Built</td>
					<td>-</td>
				</tr>
				<tr>
					<td>Cost</td>
					<td style="width:150px;">-</td>
				</tr>
				<tr>
					<td>Workers Employed</td>
					<td style="width:150px;">{{ county.get_maintenance_workers() }}</td>
				</tr>
				<tr>
					<td>Description</td>
					<td>-</td>
				</tr>
			</tbody>
		</table>
		<br>
		Gold Cost: <span id="goldCost">0</span>
		<img class="resource_icons" src="/static/images/gold_icon.jpg"> / {{ county.gold }} <img class="resource_icons" src="/static/images/gold_icon.jpg"><br>
		Wood Cost: <span id="woodCost">0</span>
		<img class="resource_icons" src="/static/images/wood_icon.jpg"> / {{ county.wood }} <img class="resource_icons" src="/static/images/wood_icon.jpg">
	</form>
</div>
{% endblock %}

{% block script %}
<script type="text/javascript">

var submitButton = document.getElementById('submitButton');

{% for building in county.buildings.values() %}
    var {{ building.base_name }}_slider = document.getElementById('{{ building.base_name }}_slider');
    {{ building.base_name }}_display = document.getElementById('{{ building.base_name }}_display');
{% endfor %}

function updateGold() {
    goldCost.innerHTML = 0{% for building in county.buildings.values() %} + {{ building.base_name }}_slider.value * {{ building.gold }}{% endfor %};
}
function updateWood() {
    woodCost.innerHTML = 0{% for building in county.buildings.values() %} + {{ building.base_name }}_slider.value * {{ building.wood }}{% endfor %};
}
function updateCosts() {
    updateGold();
    updateWood();
    var gold = parseInt(goldCost.innerHTML);
    if (gold > {{ county.gold }}) {
        goldCost.style.color = 'red';
    } else {
        goldCost.style.color = 'green';
    }
    var wood = parseInt(woodCost.innerHTML);
    if (wood > {{ county.wood }}) {
        woodCost.style.color = 'red';
    } else {
        woodCost.style.color = 'green';
    }
    if (gold <= {{ county.gold }} && wood <= {{ county.wood }}) {
        submitButton.disabled = false;
    } else {
        submitButton.disabled = true;
    }
}

{% for building in county.buildings.values() %}
    {{ building.base_name }}_slider.onchange = function() {
        {{ building.base_name }}_display.innerHTML = this.value;
        {{ building.base_name }}_value.value = this.value;
        updateCosts();
    }
{% endfor %}
button = document.getElementById('submit');
</script>
{% endblock %}

