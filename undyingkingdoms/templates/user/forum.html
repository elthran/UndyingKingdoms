{% extends "gameplay/layout.html" %}
{% set user = current_user %}

{% block title %}Forum: {{ super() }}{% endblock %}

{% block style %}
<style type="text/css">
.voteImage {
    height: 25px;
    width: 26px;
    border: none;
}

.voteImage:hover {
    box-shadow: 5px 10px 8px #888888;
}

.upvote {
    background: url("/static/images/upvote.jpg") top left no-repeat;
}

.downvote {
    background: url("/static/images/downvote.jpg") top left no-repeat;
}

#content {
    padding-top: 1em;
}
</style>
{% endblock %}

{% macro upvote_image(post) -%}
<img id="post_{{ post.id }}" class="voteImage {% if the_post.get_vote_status(current_user.id) %}upvote{% else %}downvote{% endif %}">
{%- endmacro %}

{% block content2 %}
<div id="content">
  <form method="POST" accept-charset="UTF-8" role="form">
    {{ form.csrf_token }}

    {% if the_thread == 'None' %}  <!-- Show list of all threads -->
    <h1>Forum</h1>
    <table style="border:dotted 1px;">
      <tr>
        <th>Thread</th>
        <th>Author</th>
        <th>Most Recent Post</th>
        <th>Number of Posts</th>
      </tr>
      {% for thread in forum.threads %}
      <tr>
        <td><a href="{{ url_for('forum', thread_id=thread.id, post_id=0) }}">{{ thread.title }}</a></td>
        <td>{{ thread.get_author() }}</td>
        <td>{{ thread.get_most_recent_post() }}</td>
        <td>{{ thread.get_post_count() }}</td>
      </tr>
      {% endfor %}
    </table>
    {% elif the_post == 'None' %}  <!-- Show list of all posts in that thread -->
    <h1>{{ the_thread.title }}</h1><br>
    <table style="border:dotted 1px;">
      <tr>
        <th>Post</th>
        <th>Author</th>
        <th>Most Recent Post</th>
        <th>Number of Replies</th>
      </tr>
      {% for post in the_thread.posts if post.parent_post_id == 0 %}
      <tr>
        <td><a href="{{ url_for('forum', thread_id=the_thread.id, post_id=post.id) }}">{{ post.title }}</a></td>
        <td>{{ post.get_author() }}</td>
        <td>{{ post.time_created }}</td>
        <td>{{ post.get_reply_count() }}</td>
      </tr>
      {% else %}
      <tr>
        <td>-</td>
        <td>-</td>
        <td>-</td>
        <td>-</td>
      </tr>
      {% endfor %}
    </table>
    <br><br>
    <h2>Create New Thread</h2>
    <h2 style="margin-top:5px;">{{ render_field(form.title, placeholder="Title", autofocus="") }}</h2>
    <br>
    <textarea cols="100" rows="10" name="content" placeholder="Content"></textarea>
    <br><br>
    <button type="submit">Create Post</button>
    <br><br>
    <a href="{{ url_for('forum', thread_id=0, post_id=0) }}">Return to forum home.</a>
    {% else %}  <!-- Show list of all replies in that post -->
    <ul>
      <li>
        <div>
          <h1>{{ the_post.title }} {{ upvote_image(the_post) }}</h1>
          <h3>{{ the_post.content }}</h3>
          <h3>By: {{ the_post.get_author() }} at {{ the_post.time_created }} with {{ the_post.get_votes() }} votes</h3>
        </div>
      </li>
      {% for reply in the_post.get_replies() %}
      <li><br></li>
      <li>
        <div>
          <h3>
            Reply {{ loop.index }} at {{ reply.time_created }}
            {{ upvote_image(reply) }}
          </h3>
          <h3>{{ reply.content }}</h3>
          <h3 style="font-weight:bold;">By: {{ reply.get_author() }} with {{ reply.get_votes() }} votes</h3>
        </div>
      </li>
    </ul>
      {% endfor %}
      <br><br>
      <textarea cols="100" rows="10" name="content" placeholder="Type your post here"></textarea>
      <br><br>
      <button type="submit">Reply to Post</button>
      <br><br>
      <a href="{{ url_for('forum', thread_id=the_thread.id, post_id=0) }}">Return to {{ the_thread.title }}</a>
    {% endif %}
  </form>
</div>
{% endblock %}


{% block script %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script type="text/javascript">
function toggleVote(event) {
    console.log("arg in toggleVote:", event.data.postID);
    $.get("/user/upvote/" + event.data.postID,
        function(resp, status) {
            if (status === "success") {
                $(event.data.element).toggleClass("upvote downvote");
            }
            console.log("response", resp);
            console.log("status", status);
    });
}

$(".voteImage").each(function (ignore, element) {
    postID = this.id.slice(5);
    console.log("post id:", postID);
    $(this).click({"postID": postID, "element": element}, toggleVote);
});
</script>
{% endblock %}
